
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>海上先生 - 自動解析報價</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>海上先生 - 報價自動解析系統</h2>
  <label>廠商名稱：<input id="vendor" /></label>
  <label>報價日期：<input id="date" type="date" /></label><br /><br />
  <textarea id="rawText" rows="15" cols="80" placeholder="請貼上整段報價資料"></textarea><br />
  <button onclick="parseAndUpload()">解析並上傳</button>
  <button onclick="location.href='query.html'">查詢報價</button>
  <button onclick="location.href='bulk.html'">自由輸入</button>
  <button onclick="location.href='bulk_query.html'">查詢自由報價</button>
  <div id="status"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYmv1mt2QV0Ex0J1PlASfZjA3bdBvIJws",
      authDomain: "haishang-a09c3.firebaseapp.com",
      projectId: "haishang-a09c3",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function parseAndUpload() {
      const raw = document.getElementById("rawText").value;
      const vendor = document.getElementById("vendor").value.trim();
      const date = document.getElementById("date").value;
      const lines = raw.split("\n");
      const results = [];

      let item = "";

      for (const line of lines) {
        const cleanLine = line.trim();

        // 抓第一個含「蝦仁」且能辨識出以「蝦仁」結尾的詞為品名
        if (!item && cleanLine.includes("蝦仁")) {
          const matchItem = cleanLine.match(/([\u4e00-\u9fa5]{2,10}蝦仁)/);
          if (matchItem) {
            item = matchItem[1];
          } else {
            item = cleanLine;
          }
        }

        // 找規格+價格，容許多種 * x Ｘ ＊ 符號與空白
        const match = cleanLine.match(/^(\d{2,3}\/\d{2,3})\s*[*xＸ＊]\s*(\d{3})$/i);
        if (match) {
          results.push({
            vendor,
            date,
            item: item || "蝦仁",
            spec: match[1],
            price: parseInt(match[2])
          });
        }
      }

      const status = document.getElementById("status");
      if (results.length === 0) {
        status.innerText = "❌ 無法解析任何品項，請檢查格式";
        return;
      }

      const batch = db.batch();
      results.forEach(obj => {
        const docRef = db.collection("prices").doc();
        batch.set(docRef, obj);
      });

      batch.commit().then(() => {
        status.innerText = `✅ 成功上傳 ${results.length} 筆報價資料`;
      }).catch(err => {
        status.innerText = "❌ 上傳失敗：" + err.message;
      });
    }
  </script>
</body>
</html>
