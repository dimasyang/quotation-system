<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æŸ¥è©¢å ±åƒ¹ï¼ˆRWDï¼‰</title>
  <link rel="stylesheet" href="style_rwd.css">
</head>
<body>
  <div class="container">
    <h1>æŸ¥è©¢å ±åƒ¹</h1>
    <p class="notice"><strong>Firestore é€£ç·šç‹€æ…‹ï¼š</strong><span id="fsStatus">æª¢æŸ¥ä¸­â€¦</span></p>
    <section class="card">
      <div class="grid">
        <label><span>é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šç™½è¦ä»71/90ï¼‰</span><input id="keyword" placeholder="ä¾‹å¦‚ï¼šç™½è¦ä»71/90"></label>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnSearch">æŸ¥è©¢</button>
        <button class="btn danger" id="btnDelete">åˆªé™¤æ‰€é¸</button>
        <a class="btn" id="btnHome" href="index.html">è¿”å›é¦–é </a>
        <a class="btn" id="btnTool" href="https://dimasyang.github.io/shrimp-sales-tool/">å‰å¾€å ±åƒ¹è¨ˆç®—å·¥å…·</a>
      </div>
      <p class="notice">é»ã€Œæ—¥æœŸã€å¯åˆ‡æ›æ’åºã€‚</p>

      <div class="table-wrap">
        <div class="scroll-x">
          <table class="price-table" id="resultTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>å“å</th>
                <th>è¦æ ¼</th>
                <th>åƒ¹æ ¼</th>
                <th id="thDate" style="cursor:pointer;">æ—¥æœŸ ğŸ”½</th>
                <th>å» å•†</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockSearch">æŸ¥è©¢</button>
    <button class="btn danger" id="dockDelete">åˆªé™¤æ‰€é¸</button>
    <a class="btn" id="dockHome" href="index.html">é¦–é </a>
    <a class="btn" id="dockTool" href="https://dimasyang.github.io/shrimp-sales-tool/">è¨ˆç®—å·¥å…·</a>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyAYmv1mt2QV0Ex0J1PlASfZjA3bdBvIJws",
  authDomain: "haishang-a09c3.firebaseapp.com",
  projectId: "haishang-a09c3",
  storageBucket: "haishang-a09c3.firebasestorage.app",
  messagingSenderId: "457535470987",
  appId: "1:457535470987:web:c94320eb296696e132838e"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Connectivity check
    (function() {
      const el = document.getElementById('fsStatus');
      db.collection("prices").limit(1).get()
        .then(_ => { if(el) el.textContent = "âœ… å·²é€£ç·š"; })
        .catch(err => { if(el) el.textContent = "âŒ ç„¡æ³•é€£ç·šï¼š" + (err && err.message ? err.message : err); });
    })();

    let cacheDocs = [];
    let sortDescending = true;

    function renderRows(docs){
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = "";
      docs.forEach(({id, data})=>{
        const tr = document.createElement("tr");
        tr.innerHTML = \`
          <td><input type="checkbox" class="row-check" value="\${id}"></td>
          <td>\${data.item || ""}</td>
          <td>\${data.spec || ""}</td>
          <td>\${data.price || ""}</td>
          <td>\${data.date || ""}</td>
          <td>\${data.vendor || ""}</td>\`;
        tbody.appendChild(tr);
      });
    }

    function toggleDateSort(){
      sortDescending = !sortDescending;
      document.getElementById("thDate").innerText = "æ—¥æœŸ " + (sortDescending ? "ğŸ”½" : "ğŸ”¼");
      search();
    }

    
    function search() {
      const keyword = document.getElementById("keyword").value.trim().toLowerCase();
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = "<tr><td colspan='6'>æŸ¥è©¢ä¸­...</td></tr>";
      cacheDocs = [];
      db.collection("prices").get()
        .then(qs => {
          const docs = [];
          qs.forEach(doc => docs.push({ id: doc.id, data: doc.data() }));
          // filter
          cacheDocs = docs.filter(d => {
            const item = (d.data.item||"").toLowerCase();
            const spec = (d.data.spec||"").toLowerCase();
            const vendor = (d.data.vendor||"").toLowerCase();
            return keyword === "" || item.includes(keyword) || spec.includes(keyword) || vendor.includes(keyword);
          });
          // sort by date desc/asc
          cacheDocs.sort((a,b) => {
            const da = new Date(a.data.date || "1970-01-01");
            const dbb = new Date(b.data.date || "1970-01-01");
            return sortDescending ? dbb - da : da - dbb;
          });
          // render
          if (cacheDocs.length === 0) { tbody.innerHTML = "<tr><td colspan='6'>âŒ æ‰¾ä¸åˆ°è³‡æ–™</td></tr>"; return; }
          const rows = cacheDocs.map(d => `
            <tr>
              <td><input type="checkbox" class="row-check" value="${d.id}"></td>
              <td>${d.data.item || ""}</td>
              <td>${d.data.spec || ""}</td>
              <td>${d.data.price || ""}</td>
              <td>${d.data.date || ""}</td>
              <td>${d.data.vendor || ""}</td>
            </tr>
          `).join("");
          tbody.innerHTML = rows;
        })
        .catch(err => {
          tbody.innerHTML = "<tr><td colspan='6'>è®€å–å¤±æ•—ï¼š" + (err && err.message ? err.message : err) + "</td></tr>";
        });
    }
));
      }).catch(err => {
      const tbody = document.getElementById("resultBody");
      if (tbody) tbody.innerHTML = "<tr><td colspan='6'>è®€å–å¤±æ•—ï¼š" + (err && err.message ? err.message : err) + "</td></tr>";
    });
        docs.sort((a,b)=>{
          const da = new Date(a.data.date || "1970-01-01");
          const dbb = new Date(b.data.date || "1970-01-01");
          return sortDescending ? dbb - da : da - dbb;
        });
        docs.forEach(d=>{
          const combined = (d.data.item || "") + (d.data.spec || "");
          if (keyword === "" || combined.toLowerCase().includes(keyword)) cacheDocs.push(d);
        });
        if (cacheDocs.length === 0){
          tbody.innerHTML = "<tr><td colspan='6'>âŒ æ‰¾ä¸åˆ°è³‡æ–™</td></tr>";
        }else{
          renderRows(cacheDocs);
        }
      }).catch(err=>{
        tbody.innerHTML = "<tr><td colspan='6'>âŒ æŸ¥è©¢éŒ¯èª¤ï¼š"+err.message+"</td></tr>";
      });
    }

    function toggleAll(e){
      document.querySelectorAll(".row-check").forEach(cb=> cb.checked = e.target.checked);
    }

    function deleteSelected(){
      const checked = Array.from(document.querySelectorAll(".row-check:checked"));
      if (!checked.length) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è³‡æ–™");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€é¸è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸ")) return;
      Promise.all(checked.map(c=> db.collection("prices").doc(c.value).delete()))
        .then(()=> { alert("âœ… åˆªé™¤æˆåŠŸ"); search(); })
        .catch(err=> alert("âŒ åˆªé™¤å¤±æ•—ï¼š"+err.message));
    }

    // Bind
    document.getElementById("btnSearch").onclick = search;
    document.getElementById("dockSearch").onclick = search;
    document.getElementById("btnDelete").onclick = deleteSelected;
    document.getElementById("dockDelete").onclick = deleteSelected;
    document.getElementById("btnHome").onclick = ()=> location.href='index.html';
    document.getElementById("dockHome").onclick = ()=> location.href='index.html';
    document.getElementById("btnTool").onclick = ()=> window.location.href='https://dimasyang.github.io/shrimp-sales-tool/';
    document.getElementById("dockTool").onclick = ()=> window.location.href='https://dimasyang.github.io/shrimp-sales-tool/';
    document.getElementById("selectAll").onchange = toggleAll;
    document.getElementById("thDate").onclick = toggleDateSort;
  </script>
<script src="./link-patch.js"></script>
</body>
</html>
